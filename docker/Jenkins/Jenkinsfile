pipeline {
    agent any

    environment {
        DEPLOY_DIR = "/app"
        TOMCAT_HOME = "/opt/tomcat" // ì„œë²„ì˜ Tomcat ì„¤ì¹˜ ê²½ë¡œ
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                    credentialsId: 'Deploy',
                    url: 'https://github.com/ilkwonhan/edu-egov-nexa.git'
            }
        }

        stage('Build') {
            steps {
                sh '''
                    echo "ğŸ”¨ Maven build ì‹œì‘"
                    mvn clean package -DskipTests
                    echo "ğŸ“¦ target ë””ë ‰í„°ë¦¬ í™•ì¸"
                    ls -l target
                '''
            }
        }

        stage('Deploy') {
            steps {
                sshagent(['deploy']) {
                    sh '''
                        echo "ğŸš€ ì„œë²„ ë°°í¬ ì‹œì‘"
                        
                        ssh -o StrictHostKeyChecking=no deploy@linux-server "mkdir -p ${DEPLOY_DIR}"
                        
                        WAR_FILE=$(ls target/*.war | head -n 1)
                        
                        if [ -f "$WAR_FILE" ]; then
                            echo "ğŸ“¦ WAR íŒŒì¼ ë³µì‚¬"
                            scp "$WAR_FILE" deploy@linux-server:${DEPLOY_DIR}/app.war

                            echo "â¹ Tomcat ì¢…ë£Œ"
                            ssh deploy@linux-server "${TOMCAT_HOME}/bin/shutdown.sh || true"
                            sleep 5

                            echo "ğŸ§¹ ê¸°ì¡´ ì•± ì œê±°"
                            ssh deploy@linux-server "rm -rf ${TOMCAT_HOME}/webapps/edu-egov*"

                            echo "ğŸ“¦ WAR íŒŒì¼ ë°°ì¹˜"
                            ssh deploy@linux-server "cp ${DEPLOY_DIR}/app.war ${TOMCAT_HOME}/webapps/edu-egov.war"

                            echo "â–¶ Tomcat ì‹œì‘"
                            ssh deploy@linux-server "${TOMCAT_HOME}/bin/startup.sh"

                            echo "âœ… ë°°í¬ ì™„ë£Œ! ì ‘ì† URL: http://linux-server:8080/edu-egov/"
                        else
                            echo "âŒ WAR íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
                            exit 1
                        fi
                    '''
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… CI/CD íŒŒì´í”„ë¼ì¸ ì„±ê³µ'
        }
        failure {
            echo 'âŒ CI/CD íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨'
        }
    }
}
