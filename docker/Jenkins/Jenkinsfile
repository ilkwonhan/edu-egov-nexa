pipeline {
    agent any

    environment {
        DEPLOY_DIR = "/app"
        TOMCAT_HOME = "/opt/tomcat"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                    credentialsId: 'Deploy',
                    url: 'https://github.com/ilkwonhan/edu-egov-nexa.git'
            }
        }

        stage('Build') {
            steps {
                sh '''
                    echo "ğŸ”¨ Maven build ì‹œì‘"
                    mvn clean package -DskipTests
                    echo "ğŸ“¦ target ë””ë ‰í„°ë¦¬ í™•ì¸"
                    ls -l target
                '''
            }
        }

        stage('Deploy') {
            steps {
                sshagent(['deploy']) {
                    sh '''
                        echo "ğŸš€ ì„œë²„ ë°°í¬ ì‹œì‘"

                        # ì›ê²© ì„œë²„ì— ì„ì‹œ ë””ë ‰í„°ë¦¬ ìƒì„±
                        ssh -o StrictHostKeyChecking=no deploy@linux-server "mkdir -p ${DEPLOY_DIR}"

                        # WAR íŒŒì¼ í™•ì¸
                        WAR_FILE=$(ls target/*.war | head -n 1)
                        if [ ! -f "$WAR_FILE" ]; then
                            echo "âŒ WAR íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
                            exit 1
                        fi

                        # WAR íŒŒì¼ ë³µì‚¬
                        scp "$WAR_FILE" deploy@linux-server:${DEPLOY_DIR}/app.war

                        # ê¸°ì¡´ ì•± ì œê±°
                        ssh deploy@linux-server "sudo rm -rf ${TOMCAT_HOME}/webapps/edu-egov*"

                        # ìƒˆë¡œìš´ WAR ë°°í¬
                        ssh deploy@linux-server "sudo cp ${DEPLOY_DIR}/app.war ${TOMCAT_HOME}/webapps/edu-egov.war"

                        # Tomcat ì¬ì‹œì‘
                        ssh deploy@linux-server "sudo ${TOMCAT_HOME}/bin/shutdown.sh || true"
                        ssh deploy@linux-server "sudo ${TOMCAT_HOME}/bin/startup.sh"

                        echo "âœ… ë°°í¬ ì™„ë£Œ"
                    '''
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… CI/CD íŒŒì´í”„ë¼ì¸ ì„±ê³µ'
        }
        failure {
            echo 'âŒ CI/CD íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨'
        }
    }
}
